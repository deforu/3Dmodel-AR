<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR.js Local Validation</title>
  <script src="vendor/vendoraframe.min.js"></script>
  <script src="vendor/vendoraframe-ar.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
      font-size: 2em;
      z-index: 1000;
    }
    #capture-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      font-size: 1.2em;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #f44336;
      color: white;
      padding: 16px;
      border-radius: 4px;
      z-index: 1001;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s, opacity 0.5s linear;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
    }
    
  </style>
</head>
<body>
  

  <div id="loader">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <div id="toast">ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>
  <button id="capture-btn">ğŸ“· æ’®å½±</button>

  <!-- AR.jsã®è¨­å®š: ã‚¦ã‚§ãƒ–ã‚«ãƒ¡ãƒ©ã‚’ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã—ã€ç‰¹å®šã®è§£åƒåº¦ã¨ã‚«ãƒ¡ãƒ©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¾ã™ã€‚ -->
  <a-scene
    embedded
    arjs="
      sourceType: webcam;
      sourceWidth: 640;
      sourceHeight: 480;
      displayWidth: 640;
      displayHeight: 480;
      debugUIEnabled: false;
      cameraParametersUrl: vendor/camera_para.dat;
    "
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; preserveDrawingBuffer: true"
    id="scene"
  >
  <!-- 3Dãƒ¢ãƒ‡ãƒ«ã®ã‚¢ã‚»ãƒƒãƒˆ: ã“ã“ã§3Dãƒ¢ãƒ‡ãƒ«ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ -->
    <a-assets>
        <a-asset-item id="user-model" src="assets/Merge_01_tex.gltf"></a-asset-item>
    </a-assets>

    <a-marker type="pattern" url="vendor/hiro.patt" id="marker">
      <!-- ãƒ‡ãƒãƒƒã‚°ç”¨å¹³é¢: ãƒãƒ¼ã‚«ãƒ¼ã®å‘ãã‚„ä½ç½®ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®åŠé€æ˜ã®ç·‘è‰²ã®å¹³é¢ã§ã™ã€‚-->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="1"
        height="1"
        material="opacity: 0.5; color: #00ff00;"
      ></a-plane>

      <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒœãƒƒã‚¯ã‚¹: ãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹å‰ã«ä¸€æ™‚çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ç·‘è‰²ã®ãƒœãƒƒã‚¯ã‚¹ã§ã™ã€‚-->
      <a-box
        id="debug-box"
        position="0 0.25 0"
        scale="0.2 0.2 0.2"
        material="color: green;"
        visible="true"
      ></a-box>

      <!-- 3Dãƒ¢ãƒ‡ãƒ«: ã“ã“ã«è¡¨ç¤ºã—ãŸã„3Dãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚gltf-modelå±æ€§ã§a-assetsã§å®šç¾©ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’å‚ç…§ã—ã¾ã™ã€‚-->
      <a-entity
        id="model"
        rotation="-90 0 0"
        gltf-model="#user-model"

        auto-place="targetSize: 2.0; layFlat: false" 
        visible="false"
      ></a-entity>
    </a-marker>
    <!-- ã‚«ãƒ¡ãƒ©ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: AR.jsãŒãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚ -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // auto-place ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: 3Dãƒ¢ãƒ‡ãƒ«ã‚’ãƒãƒ¼ã‚«ãƒ¼ä¸Šã«è‡ªå‹•ã§é…ç½®ã€ã‚¹ã‚±ãƒ¼ãƒ«ã€ä½ç½®èª¿æ•´ã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚
    AFRAME.registerComponent('auto-place', {
      schema: {
        targetSize: { type: 'number', default: 0.3 },
        layFlat: { type: 'boolean', default: false }
      },
      init: function () {
        this.el.addEventListener('model-loaded', (e) => {
          console.log('[model] loaded');
          const model = e.detail.model;
          if (!model) {
            console.error('[auto-place] model not found in event detail.');
            return;
          }

          // ãƒ¢ãƒ‡ãƒ«ãŒã‚·ãƒ¼ãƒ³ã‚°ãƒ©ãƒ•ã«å®Œå…¨ã«çµ±åˆã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…æ©Ÿã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ­£ç¢ºãªãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¨ˆç®—ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
          setTimeout(() => {
            const el = this.el;

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®è¨ˆç®—: ãƒ¢ãƒ‡ãƒ«ã®ã‚µã‚¤ã‚ºã¨ä¸­å¿ƒã‚’æŠŠæ¡ã—ã¾ã™ã€‚
            const box = new THREE.Box3().setFromObject(model);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());

            // 1. ãƒ¢ãƒ‡ãƒ«ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªè‡ªä½“ã‚’ä¸­å¤®ã«é…ç½®ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¡ãƒƒã‚·ãƒ¥ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®åŸç‚¹ã«å¯¾ã—ã¦ç§»å‹•ã—ã¾ã™ã€‚
            model.position.x -= center.x;
            model.position.y -= center.y;
            model.position.z -= center.z;

            // 2. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç›®æ¨™ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¾ã™ã€‚
            const maxDim = Math.max(size.x, size.y, size.z);
            if (maxDim > 0) {
              const scale = this.data.targetSize / maxDim;
              el.setAttribute('scale', `${scale} ${scale} ${scale}`);
            }

            // 3. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é…ç½®ã—ã¾ã™ã€‚ã‚¹ã‚±ãƒ¼ãƒ«å¾Œã€ãƒ¢ãƒ‡ãƒ«ã®ã€Œåº•ã€ãŒy=0ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã™ã€‚
            const scaledY = (size.y / 2) * (el.object3D.scale.y);
            el.object3D.position.y = scaledY;

            // 4. ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ¢ãƒ‡ãƒ«ã‚’å¹³å¦åŒ–ï¼ˆXè»¸ã«-90åº¦å›è»¢ï¼‰ã—ã¾ã™ã€‚
            if (this.data.layFlat) {
              el.setAttribute('rotation', '-90 0 0');
            }

            // 5. ãƒ¢ãƒ‡ãƒ«ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç·‘è‰²ã®ãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤ºã«ã—ã¾ã™ã€‚
            document.querySelector('#debug-box').setAttribute('visible', 'false');
            el.setAttribute('visible', 'true');
            console.log('[model] auto-placed and made visible.');
          }, 0);
        });
      }
    });


    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const loaderEl = document.querySelector('#loader');
      const markerEl = document.querySelector('#marker');
      const modelEl = document.querySelector('#model'); // Get model element
      const captureBtn = document.querySelector('#capture-btn');
      const toastEl = document.querySelector('#toast');

      let captureWidth = 640;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è§£åƒåº¦
      let captureHeight = 480; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è§£åƒåº¦

      // --- ã‚·ãƒ¼ãƒ³ã®æº–å‚™ãŒã§ããŸã¨ãã«ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ ---
      sceneEl.addEventListener('loaded', () => {
        console.log('[a-scene] loaded');
        loaderEl.style.display = 'none';
      });

      // --- ã‚«ãƒ¡ãƒ©è§£åƒåº¦ã®å–å¾— ---
      sceneEl.addEventListener('camera-init', (data) => {
        console.log('[camera-init]', data);
        if (data.detail.error) {
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
            return;
        }
        const video = document.querySelector('video');
        if (video) {
          video.addEventListener('loadedmetadata', () => {
            // å®Ÿéš›ã®ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰è§£åƒåº¦ã‚’è¨˜æ†¶ã—ã¦ãŠã
            captureWidth = video.videoWidth;
            captureHeight = video.videoHeight;
            console.log(`[camera] Capture resolution discovered: ${captureWidth}x${captureHeight}`);
          });
        }
      });

      markerEl.addEventListener('markerFound', () => {
        console.log('[marker] found');
      });

      markerEl.addEventListener('markerLost', () => {
        console.log('[marker] lost');
      });

      // --- ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ãƒ­ã‚° ---
      modelEl.addEventListener('model-error', (e) => {
        console.error('[model] Error loading model:', e.detail.src);
        alert(`Failed to load model from ${e.detail.src}. Check console for details.`);
      });

      // --- æ’®å½±ãƒœã‚¿ãƒ³ã®å‡¦ç† ---
      captureBtn.addEventListener('click', () => {
        // 1. æ’®å½±ç›´å‰ã«ã€è¨˜æ†¶ã—ã¦ãŠã„ãŸè§£åƒåº¦ã‚’screenshotã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¨­å®š
        sceneEl.setAttribute('screenshot', {
          width: captureWidth,
          height: captureHeight
        });

        // 2. A-FrameãŒè¨­å®šã‚’é©ç”¨ã™ã‚‹ã®ã‚’å¾…ã¤ãŸã‚ã€ä¸€ç¬é…å»¶ã•ã›ã‚‹
        setTimeout(() => {
          const video = document.querySelector('video');
          const glCanvas = sceneEl.components.screenshot.getCanvas('perspective');

          if (!video || !glCanvas || glCanvas.width === 0) {
            console.error('Failed to get valid canvas for capture.');
            return;
          }

          const compositeCanvas = document.createElement('canvas');
          const ctx = compositeCanvas.getContext('2d');

          compositeCanvas.width = captureWidth;
          compositeCanvas.height = captureHeight;

          // èƒŒæ™¯(ãƒ“ãƒ‡ã‚ª)ã¨å‰æ™¯(3Dãƒ¢ãƒ‡ãƒ«)ã‚’åˆæˆ
          ctx.drawImage(video, 0, 0, captureWidth, captureHeight);
          ctx.drawImage(glCanvas, 0, 0);

          // ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const link = document.createElement('a');
          link.href = compositeCanvas.toDataURL('image/png');
          link.download = 'ar-capture.png';
          link.click();
        }, 0); // 0msã®é…å»¶ã§ã€æ¬¡ã®æç”»ã‚µã‚¤ã‚¯ãƒ«ã§å‡¦ç†ã‚’å®Ÿè¡Œã•ã›ã‚‹
      });
    });
  </script>
</body>
</html>
